#!/usr/bin/env bash
# Configures a new Ubuntu machine by installing Nginx, setting up a Hello World page,
# and configuring a redirection to a YouTube video.

echo "Updating package lists and installing Nginx..."
sudo apt-get update -y -qq && sudo apt-get install nginx -y

if [ $? -ne 0 ]; then
    echo "Error: Nginx installation failed. Exiting."
    exit 1
fi

echo "Starting Nginx service..."
sudo service nginx start

# Check if UFW is enabled before adding firewall rules
if sudo ufw status | grep -q "Status: active"; then
    echo "Allowing Nginx HTTP traffic in firewall..."
    sudo ufw allow 'Nginx HTTP'
    sudo ufw reload
else
    echo "UFW firewall is not active. Skipping firewall configuration."
fi

echo "Setting permissions for website files..."
sudo chown -R "$USER":"$USER" /var/www/html
sudo chmod -R 755 /var/www

echo "Creating index page with 'Hello World!'..."
echo "Hello World!" | sudo tee /var/www/html/index.nginx-debian.html > /dev/null

echo "Configuring redirection..."
sudo sed -i '24i\       rewrite ^/redirect_me https://www.youtube.com/watch?v=QH2-TGUlwu4 permanent;' /etc/nginx/sites-available/default

echo "Restarting Nginx service to apply changes..."
sudo service nginx restart

echo "Nginx setup completed successfully."
